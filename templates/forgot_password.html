<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Şifremi Unuttum - Saha Gözlem</title>
  <link rel="stylesheet" href="/static/styles.css">
</head>
<body style="background: linear-gradient(135deg, #032f0c 0%, #1e5a2b 100%); min-height: 100vh; display: flex; align-items: center; justify-content: center;">
  <div style="background: white; border-radius: 24px; padding: 48px; max-width: 420px; margin: 16px; width: 100%; box-sizing: border-box;">
    
    {% if step == "request" %}
    <!-- Adım 1: Kullanıcı seçimi -->
    <div style="text-align: center; margin-bottom: 32px;">
      <h1 style="color: #032f0c; font-size: 28px; font-weight: 800; margin-bottom: 8px;">Şifre Sıfırlama</h1>
      <p style="color: #6b7280; font-size: 14px;">Şifrenizi sıfırlamak için adınızı seçin</p>
    </div>
    
    {% set error_param = request.query_params.get('error') %}
    {% if error_param %}
      <div style="background: #fef2f2; border: 1px solid #fecaca; color: #dc2626; padding: 12px 16px; border-radius: 12px; margin-bottom: 24px; text-align: center; font-size: 14px;">{{ error_param }}</div>
    {% endif %}
    
    <form method="post" action="/forgot-password-request">
      <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #374151;">Bölge Müdürü</label>
      <select name="manager_name" required style="width: 100%; padding: 16px; border: 2px solid #e5e7eb; border-radius: 16px; font-size: 16px; margin-bottom: 24px; box-sizing: border-box;">
        <option value="" disabled selected>Adınızı seçin</option>
        {% for manager in managers %}
          <option value="{{ manager }}">{{ manager }}</option>
        {% endfor %}
      </select>
      
      <div style="display: flex; gap: 12px;">
        <button type="submit" style="flex: 1; background: linear-gradient(135deg, #032f0c 0%, #1e5a2b 100%); color: white; border: none; padding: 18px; border-radius: 16px; font-size: 16px; font-weight: 700; cursor: pointer; transition: all 0.2s ease;">
          Sıfırlama Kodu Gönder
        </button>
        <a href="/login" style="flex: 0 0 auto; background: #f3f4f6; color: #374151; padding: 18px 24px; border-radius: 16px; font-size: 16px; font-weight: 700; text-decoration: none; display: flex; align-items: center; justify-content: center;">
          Geri
        </a>
      </div>
    </form>
    
    {% elif step == "code" %}
    <!-- Adım 2: Kod girişi ve yeni şifre -->
    <div style="text-align: center; margin-bottom: 32px;">
      <h1 style="color: #032f0c; font-size: 28px; font-weight: 800; margin-bottom: 8px;">Şifre Sıfırlama</h1>
      <p style="color: #6b7280; font-size: 14px;">{{ manager_name }} için yeni şifre belirleyin</p>
    </div>
    
    {% if temp_code %}
    <!-- Demo için geçici kodu göster -->
    <div style="background: #eff6ff; border: 1px solid #93c5fd; color: #1d4ed8; padding: 16px; border-radius: 12px; margin-bottom: 24px; text-align: center;">
      <div style="font-weight: 600; margin-bottom: 4px;">Geçici Kodunuz:</div>
      <div style="font-size: 24px; font-weight: 800; font-family: monospace; letter-spacing: 2px;">{{ temp_code }}</div>
      <div style="font-size: 12px; margin-top: 4px;">Geçerlilik: {{ expires }}'e kadar</div>
    </div>
    {% endif %}
    
    {% if error %}
      <div style="background: #fef2f2; border: 1px solid #fecaca; color: #dc2626; padding: 12px 16px; border-radius: 12px; margin-bottom: 24px; text-align: center; font-size: 14px;">{{ error }}</div>
    {% endif %}
    
    <form method="post" action="/forgot-password-reset" id="resetForm">
      <input type="hidden" name="manager_name" value="{{ manager_name }}">
      
      <!-- Geçici Kod -->
      <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #374151;">Geçici Kod</label>
      <input type="text" name="temp_code" id="tempCode" required placeholder="6 haneli kodu girin" maxlength="6"
             style="width: 100%; padding: 16px; border: 2px solid #e5e7eb; border-radius: 16px; font-size: 18px; margin-bottom: 20px; box-sizing: border-box; text-align: center; font-family: monospace; letter-spacing: 2px;">
      
      <!-- Yeni Şifre -->
      <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #374151;">Yeni Şifre</label>
      <input type="password" name="new_password" id="newPassword" required placeholder="Yeni şifrenizi girin" minlength="4"
             style="width: 100%; padding: 16px; border: 2px solid #e5e7eb; border-radius: 16px; font-size: 16px; margin-bottom: 20px; box-sizing: border-box;">
      
      <!-- Yeni Şifre Tekrar -->
      <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #374151;">Yeni Şifre (Tekrar)</label>
      <input type="password" name="confirm_password" id="confirmPassword" required placeholder="Yeni şifrenizi tekrar girin" minlength="4"
             style="width: 100%; padding: 16px; border: 2px solid #e5e7eb; border-radius: 16px; font-size: 16px; margin-bottom: 24px; box-sizing: border-box;">
      
      <div style="display: flex; gap: 12px;">
        <button type="submit" id="resetButton" disabled style="flex: 1; background: linear-gradient(135deg, #032f0c 0%, #1e5a2b 100%); color: white; border: none; padding: 18px; border-radius: 16px; font-size: 16px; font-weight: 700; cursor: pointer; transition: all 0.2s ease; opacity: 0.5;">
          Şifre Sıfırla
        </button>
        <a href="/login" style="flex: 0 0 auto; background: #f3f4f6; color: #374151; padding: 18px 24px; border-radius: 16px; font-size: 16px; font-weight: 700; text-decoration: none; display: flex; align-items: center; justify-content: center;">
          İptal
        </a>
      </div>
    </form>
    
    {% endif %}
  </div>
  
  <style>
    /* Hover efektleri */
    button:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(3,47,12,0.3);
    }
    
    button:active:not(:disabled) {
      transform: translateY(0);
    }
    
    a:hover {
      background: #e5e7eb !important;
    }
    
    /* Focus efektleri */
    input:focus, select:focus {
      border-color: #032f0c !important;
      outline: none !important;
      box-shadow: 0 0 0 3px rgba(3,47,12,0.1) !important;
    }
    
    /* Disabled button */
    button:disabled {
      cursor: not-allowed !important;
      opacity: 0.5 !important;
    }
    
    button:not(:disabled) {
      opacity: 1 !important;
    }
    
    /* Loading durumu */
    .loading {
      opacity: 0.7;
      pointer-events: none;
    }
    
    /* Özel stil: Geçici kod input */
    #tempCode {
      font-weight: 700;
    }
    
    /* Responsive design */
    @media (max-width: 480px) {
      body > div {
        padding: 32px 24px !important;
        margin: 8px !important;
        max-width: none !important;
      }
      
      h1 {
        font-size: 24px !important;
        margin-bottom: 8px !important;
      }
      
      input, select {
        padding: 14px !important;
        font-size: 15px !important;
      }
      
      button, a {
        padding: 16px !important;
        font-size: 15px !important;
      }
    }
  </style>
  
  <script>
    {% if step == "code" %}
    // Geçici kod input formatlaması
    document.getElementById('tempCode').addEventListener('input', function(e) {
      // Sadece rakam kabul et
      let value = e.target.value.replace(/[^0-9]/g, '');
      if (value.length > 6) value = value.slice(0, 6);
      e.target.value = value;
      
      checkFormValidity();
    });
    
    // Form geçerliliği kontrolü
    function checkFormValidity() {
      const tempCode = document.getElementById('tempCode').value;
      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      const resetButton = document.getElementById('resetButton');
      
      const isValid = tempCode.length === 6 && 
                     newPassword.length >= 4 && 
                     confirmPassword.length >= 4 && 
                     newPassword === confirmPassword;
      
      resetButton.disabled = !isValid;
      
      // Şifre eşleşmeme göstergesi
      const confirmField = document.getElementById('confirmPassword');
      if (confirmPassword.length > 0 && newPassword !== confirmPassword) {
        confirmField.style.borderColor = '#dc2626';
        confirmField.style.boxShadow = '0 0 0 3px rgba(220, 38, 38, 0.1)';
      } else {
        confirmField.style.borderColor = '#e5e7eb';
        confirmField.style.boxShadow = 'none';
      }
    }
    
    // Event listeners
    document.getElementById('newPassword').addEventListener('input', checkFormValidity);
    document.getElementById('confirmPassword').addEventListener('input', checkFormValidity);
    
    // Form submit
    document.getElementById('resetForm').addEventListener('submit', function() {
      const button = document.getElementById('resetButton');
      button.classList.add('loading');
      button.textContent = 'Şifre sıfırlanıyor...';
    });
    
    // Otomatik focus
    document.getElementById('tempCode').focus();
    {% endif %}
  </script>
</body>
</html>